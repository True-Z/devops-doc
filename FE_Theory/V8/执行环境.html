<!DOCTYPE html>
<html lang="zh-CN" dir="ltr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>V8 执行环境 | DevOps</title>
    <meta name="description" content="A VitePress site">
    <link rel="preload stylesheet" href="/devops-doc/assets/style.8193b64a.css" as="style">
    
    <script type="module" src="/devops-doc/assets/app.3f0be921.js"></script>
    <link rel="preload" href="/devops-doc/assets/inter-roman-latin.2ed14f66.woff2" as="font" type="font/woff2" crossorigin="">
    <link rel="modulepreload" href="/devops-doc/assets/chunks/framework.32dba02b.js">
    <link rel="modulepreload" href="/devops-doc/assets/chunks/theme.3910909c.js">
    <link rel="modulepreload" href="/devops-doc/assets/FE_Theory_V8_执行环境.md.ba24f863.lean.js">
    <link rel="icon" href="/devops-doc/favicon.ico">
    <script id="check-dark-light">(()=>{const e=localStorage.getItem("vitepress-theme-appearance")||"dark",a=window.matchMedia("(prefers-color-scheme: dark)").matches;(!e||e==="auto"?a:e==="dark")&&document.documentElement.classList.add("dark")})();</script>
  </head>
  <body>
    <div id="app"><div class="Layout" data-v-bf985812><!--[--><!--]--><!--[--><span tabindex="-1" data-v-8fe4a9f9></span><a href="#VPContent" class="VPSkipLink visually-hidden" data-v-8fe4a9f9> Skip to content </a><!--]--><!----><header class="VPNav" data-v-bf985812 data-v-1fbd871e><div class="VPNavBar has-sidebar" data-v-1fbd871e data-v-66bc1ac8><div class="container" data-v-66bc1ac8><div class="title" data-v-66bc1ac8><div class="VPNavBarTitle has-sidebar" data-v-66bc1ac8 data-v-509ec29d><a class="title" href="/devops-doc/" data-v-509ec29d><!--[--><!--]--><!----><!--[-->DevOps<!--]--><!--[--><!--]--></a></div></div><div class="content" data-v-66bc1ac8><div class="curtain" data-v-66bc1ac8></div><div class="content-body" data-v-66bc1ac8><!--[--><!--]--><div class="VPNavBarSearch search" style="--vp-meta-key:&#39;Meta&#39;;" data-v-66bc1ac8><!--[--><!----><div id="local-search"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg class="DocSearch-Search-Icon" width="20" height="20" viewBox="0 0 20 20" aria-label="search icon"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"><kbd class="DocSearch-Button-Key"></kbd><kbd class="DocSearch-Button-Key">K</kbd></span></button></div><!--]--></div><nav aria-labelledby="main-nav-aria-label" class="VPNavBarMenu menu" data-v-66bc1ac8 data-v-2b8fa8b7><span id="main-nav-aria-label" class="visually-hidden" data-v-2b8fa8b7>Main Navigation</span><!--[--><!--[--><div class="VPFlyout VPNavBarMenuGroup" data-v-2b8fa8b7 data-v-5c09fe72><button type="button" class="button" aria-haspopup="true" aria-expanded="false" data-v-5c09fe72><span class="text" data-v-5c09fe72><!----><span data-v-5c09fe72>计算机</span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="text-icon" data-v-5c09fe72><path d="M12,16c-0.3,0-0.5-0.1-0.7-0.3l-6-6c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l5.3,5.3l5.3-5.3c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-6,6C12.5,15.9,12.3,16,12,16z"></path></svg></span></button><div class="menu" data-v-5c09fe72><div class="VPMenu" data-v-5c09fe72 data-v-95e2625a><div class="items" data-v-95e2625a><!--[--><!--[--><div class="VPMenuGroup" data-v-95e2625a data-v-eb32d3df><p class="title" data-v-eb32d3df>计算机基础</p><!--[--><!--[--><div class="VPMenuLink" data-v-eb32d3df data-v-36d9398d><a class="VPLink link" href="/devops-doc/Computer_Theory/操作系统/" data-v-36d9398d><!--[-->操作系统<!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-eb32d3df data-v-36d9398d><a class="VPLink link" href="/devops-doc/Computer_Theory/计算机组成原理/" data-v-36d9398d><!--[-->计算机组成原理<!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-eb32d3df data-v-36d9398d><a class="VPLink link" href="/devops-doc/Computer_Theory/计算机网络/" data-v-36d9398d><!--[-->计算机网络<!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-eb32d3df data-v-36d9398d><a class="VPLink link" href="/devops-doc/Computer_Theory/数据结构/" data-v-36d9398d><!--[-->数据结构<!--]--></a></div><!--]--><!--]--></div><!--]--><!--[--><div class="VPMenuGroup" data-v-95e2625a data-v-eb32d3df><p class="title" data-v-eb32d3df>计算机应用</p><!--[--><!--[--><div class="VPMenuLink" data-v-eb32d3df data-v-36d9398d><a class="VPLink link" href="/devops-doc/Computer_Apply/DB/" data-v-36d9398d><!--[-->数据库<!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-eb32d3df data-v-36d9398d><a class="VPLink link" href="/devops-doc/Computer_Apply/设计模式/" data-v-36d9398d><!--[-->设计模式<!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-eb32d3df data-v-36d9398d><a class="VPLink link" href="/devops-doc/Computer_Apply/算法/" data-v-36d9398d><!--[-->算法<!--]--></a></div><!--]--><!--]--></div><!--]--><!--[--><div class="VPMenuGroup" data-v-95e2625a data-v-eb32d3df><p class="title" data-v-eb32d3df>计算机系统</p><!--[--><!--[--><div class="VPMenuLink" data-v-eb32d3df data-v-36d9398d><a class="VPLink link" href="/devops-doc/Computer_System/Windows/" data-v-36d9398d><!--[-->Windows<!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-eb32d3df data-v-36d9398d><a class="VPLink link" href="/devops-doc/Computer_System/Linux/" data-v-36d9398d><!--[-->Linux<!--]--></a></div><!--]--><!--]--></div><!--]--><!--]--></div><!--[--><!--]--></div></div></div><!--]--><!--[--><div class="VPFlyout VPNavBarMenuGroup" data-v-2b8fa8b7 data-v-5c09fe72><button type="button" class="button" aria-haspopup="true" aria-expanded="false" data-v-5c09fe72><span class="text" data-v-5c09fe72><!----><span data-v-5c09fe72>前端</span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="text-icon" data-v-5c09fe72><path d="M12,16c-0.3,0-0.5-0.1-0.7-0.3l-6-6c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l5.3,5.3l5.3-5.3c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-6,6C12.5,15.9,12.3,16,12,16z"></path></svg></span></button><div class="menu" data-v-5c09fe72><div class="VPMenu" data-v-5c09fe72 data-v-95e2625a><div class="items" data-v-95e2625a><!--[--><!--[--><div class="VPMenuGroup" data-v-95e2625a data-v-eb32d3df><p class="title" data-v-eb32d3df>原理</p><!--[--><!--[--><div class="VPMenuLink" data-v-eb32d3df data-v-36d9398d><a class="VPLink link" href="/devops-doc/FE_Theory/V8/" data-v-36d9398d><!--[-->V8<!--]--></a></div><!--]--><!--]--></div><!--]--><!--[--><div class="VPMenuGroup" data-v-95e2625a data-v-eb32d3df><p class="title" data-v-eb32d3df>要点</p><!--[--><!--[--><div class="VPMenuLink" data-v-eb32d3df data-v-36d9398d><a class="VPLink link" href="/devops-doc/FE_Point/HTML/" data-v-36d9398d><!--[-->HTML<!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-eb32d3df data-v-36d9398d><a class="VPLink link" href="/devops-doc/FE_Point/CSS/" data-v-36d9398d><!--[-->CSS<!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-eb32d3df data-v-36d9398d><a class="VPLink link" href="/devops-doc/FE_Point/JavaScript/" data-v-36d9398d><!--[-->JavaScript<!--]--></a></div><!--]--><!--]--></div><!--]--><!--]--></div><!--[--><!--]--></div></div></div><!--]--><!--[--><div class="VPFlyout VPNavBarMenuGroup" data-v-2b8fa8b7 data-v-5c09fe72><button type="button" class="button" aria-haspopup="true" aria-expanded="false" data-v-5c09fe72><span class="text" data-v-5c09fe72><!----><span data-v-5c09fe72>工具</span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="text-icon" data-v-5c09fe72><path d="M12,16c-0.3,0-0.5-0.1-0.7-0.3l-6-6c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l5.3,5.3l5.3-5.3c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-6,6C12.5,15.9,12.3,16,12,16z"></path></svg></span></button><div class="menu" data-v-5c09fe72><div class="VPMenu" data-v-5c09fe72 data-v-95e2625a><div class="items" data-v-95e2625a><!--[--><!--[--><div class="VPMenuGroup" data-v-95e2625a data-v-eb32d3df><p class="title" data-v-eb32d3df>IDE</p><!--[--><!--[--><div class="VPMenuLink" data-v-eb32d3df data-v-36d9398d><a class="VPLink link" href="/devops-doc/Tools_IDE/JetBrains/" data-v-36d9398d><!--[-->JetBrains<!--]--></a></div><!--]--><!--]--></div><!--]--><!--[--><div class="VPMenuGroup" data-v-95e2625a data-v-eb32d3df><p class="title" data-v-eb32d3df>Ops</p><!--[--><!--[--><div class="VPMenuLink" data-v-eb32d3df data-v-36d9398d><a class="VPLink link" href="/devops-doc/Tools_Git/" data-v-36d9398d><!--[-->Git<!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-eb32d3df data-v-36d9398d><a class="VPLink link" href="/devops-doc/Tools_Ops/Npm/" data-v-36d9398d><!--[-->Npm<!--]--></a></div><!--]--><!--]--></div><!--]--><!--]--></div><!--[--><!--]--></div></div></div><!--]--><!--]--></nav><!----><div class="VPNavBarAppearance appearance" data-v-66bc1ac8 data-v-141ce888><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title="toggle dark mode" aria-checked="false" data-v-141ce888 data-v-2a45a772 data-v-a4d034d8><span class="check" data-v-a4d034d8><span class="icon" data-v-a4d034d8><!--[--><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="sun" data-v-2a45a772><path d="M12,18c-3.3,0-6-2.7-6-6s2.7-6,6-6s6,2.7,6,6S15.3,18,12,18zM12,8c-2.2,0-4,1.8-4,4c0,2.2,1.8,4,4,4c2.2,0,4-1.8,4-4C16,9.8,14.2,8,12,8z"></path><path d="M12,4c-0.6,0-1-0.4-1-1V1c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,3.6,12.6,4,12,4z"></path><path d="M12,24c-0.6,0-1-0.4-1-1v-2c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,23.6,12.6,24,12,24z"></path><path d="M5.6,6.6c-0.3,0-0.5-0.1-0.7-0.3L3.5,4.9c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C6.2,6.5,5.9,6.6,5.6,6.6z"></path><path d="M19.8,20.8c-0.3,0-0.5-0.1-0.7-0.3l-1.4-1.4c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C20.3,20.7,20,20.8,19.8,20.8z"></path><path d="M3,13H1c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S3.6,13,3,13z"></path><path d="M23,13h-2c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S23.6,13,23,13z"></path><path d="M4.2,20.8c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C4.7,20.7,4.5,20.8,4.2,20.8z"></path><path d="M18.4,6.6c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C18.9,6.5,18.6,6.6,18.4,6.6z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="moon" data-v-2a45a772><path d="M12.1,22c-0.3,0-0.6,0-0.9,0c-5.5-0.5-9.5-5.4-9-10.9c0.4-4.8,4.2-8.6,9-9c0.4,0,0.8,0.2,1,0.5c0.2,0.3,0.2,0.8-0.1,1.1c-2,2.7-1.4,6.4,1.3,8.4c2.1,1.6,5,1.6,7.1,0c0.3-0.2,0.7-0.3,1.1-0.1c0.3,0.2,0.5,0.6,0.5,1c-0.2,2.7-1.5,5.1-3.6,6.8C16.6,21.2,14.4,22,12.1,22zM9.3,4.4c-2.9,1-5,3.6-5.2,6.8c-0.4,4.4,2.8,8.3,7.2,8.7c2.1,0.2,4.2-0.4,5.8-1.8c1.1-0.9,1.9-2.1,2.4-3.4c-2.5,0.9-5.3,0.5-7.5-1.1C9.2,11.4,8.1,7.7,9.3,4.4z"></path></svg><!--]--></span></span></button></div><div class="VPSocialLinks VPNavBarSocialLinks social-links" data-v-66bc1ac8 data-v-90e3ba4e data-v-c435d484><!--[--><a class="VPSocialLink no-icon" href="https://github.com/True-Z" aria-label="github" target="_blank" rel="noopener" data-v-c435d484 data-v-f1199cb5><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>GitHub</title><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a><!--]--></div><div class="VPFlyout VPNavBarExtra extra" data-v-66bc1ac8 data-v-7f68c200 data-v-5c09fe72><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="extra navigation" data-v-5c09fe72><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="icon" data-v-5c09fe72><circle cx="12" cy="12" r="2"></circle><circle cx="19" cy="12" r="2"></circle><circle cx="5" cy="12" r="2"></circle></svg></button><div class="menu" data-v-5c09fe72><div class="VPMenu" data-v-5c09fe72 data-v-95e2625a><!----><!--[--><!--[--><!----><div class="group" data-v-7f68c200><div class="item appearance" data-v-7f68c200><p class="label" data-v-7f68c200>Appearance</p><div class="appearance-action" data-v-7f68c200><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title="toggle dark mode" aria-checked="false" data-v-7f68c200 data-v-2a45a772 data-v-a4d034d8><span class="check" data-v-a4d034d8><span class="icon" data-v-a4d034d8><!--[--><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="sun" data-v-2a45a772><path d="M12,18c-3.3,0-6-2.7-6-6s2.7-6,6-6s6,2.7,6,6S15.3,18,12,18zM12,8c-2.2,0-4,1.8-4,4c0,2.2,1.8,4,4,4c2.2,0,4-1.8,4-4C16,9.8,14.2,8,12,8z"></path><path d="M12,4c-0.6,0-1-0.4-1-1V1c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,3.6,12.6,4,12,4z"></path><path d="M12,24c-0.6,0-1-0.4-1-1v-2c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,23.6,12.6,24,12,24z"></path><path d="M5.6,6.6c-0.3,0-0.5-0.1-0.7-0.3L3.5,4.9c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C6.2,6.5,5.9,6.6,5.6,6.6z"></path><path d="M19.8,20.8c-0.3,0-0.5-0.1-0.7-0.3l-1.4-1.4c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C20.3,20.7,20,20.8,19.8,20.8z"></path><path d="M3,13H1c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S3.6,13,3,13z"></path><path d="M23,13h-2c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S23.6,13,23,13z"></path><path d="M4.2,20.8c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C4.7,20.7,4.5,20.8,4.2,20.8z"></path><path d="M18.4,6.6c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C18.9,6.5,18.6,6.6,18.4,6.6z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="moon" data-v-2a45a772><path d="M12.1,22c-0.3,0-0.6,0-0.9,0c-5.5-0.5-9.5-5.4-9-10.9c0.4-4.8,4.2-8.6,9-9c0.4,0,0.8,0.2,1,0.5c0.2,0.3,0.2,0.8-0.1,1.1c-2,2.7-1.4,6.4,1.3,8.4c2.1,1.6,5,1.6,7.1,0c0.3-0.2,0.7-0.3,1.1-0.1c0.3,0.2,0.5,0.6,0.5,1c-0.2,2.7-1.5,5.1-3.6,6.8C16.6,21.2,14.4,22,12.1,22zM9.3,4.4c-2.9,1-5,3.6-5.2,6.8c-0.4,4.4,2.8,8.3,7.2,8.7c2.1,0.2,4.2-0.4,5.8-1.8c1.1-0.9,1.9-2.1,2.4-3.4c-2.5,0.9-5.3,0.5-7.5-1.1C9.2,11.4,8.1,7.7,9.3,4.4z"></path></svg><!--]--></span></span></button></div></div></div><div class="group" data-v-7f68c200><div class="item social-links" data-v-7f68c200><div class="VPSocialLinks social-links-list" data-v-7f68c200 data-v-c435d484><!--[--><a class="VPSocialLink no-icon" href="https://github.com/True-Z" aria-label="github" target="_blank" rel="noopener" data-v-c435d484 data-v-f1199cb5><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>GitHub</title><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a><!--]--></div></div></div><!--]--><!--]--></div></div></div><!--[--><!--]--><button type="button" class="VPNavBarHamburger hamburger" aria-label="mobile navigation" aria-expanded="false" aria-controls="VPNavScreen" data-v-66bc1ac8 data-v-e6fc6527><span class="container" data-v-e6fc6527><span class="top" data-v-e6fc6527></span><span class="middle" data-v-e6fc6527></span><span class="bottom" data-v-e6fc6527></span></span></button></div></div></div></div><!----></header><div class="VPLocalNav reached-top" data-v-bf985812 data-v-71a62d02><button class="menu" aria-expanded="false" aria-controls="VPSidebarNav" data-v-71a62d02><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="menu-icon" data-v-71a62d02><path d="M17,11H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h14c0.6,0,1,0.4,1,1S17.6,11,17,11z"></path><path d="M21,7H3C2.4,7,2,6.6,2,6s0.4-1,1-1h18c0.6,0,1,0.4,1,1S21.6,7,21,7z"></path><path d="M21,15H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h18c0.6,0,1,0.4,1,1S21.6,15,21,15z"></path><path d="M17,19H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h14c0.6,0,1,0.4,1,1S17.6,19,17,19z"></path></svg><span class="menu-text" data-v-71a62d02>Menu</span></button><div class="VPLocalNavOutlineDropdown" style="--vp-vh:0px;" data-v-71a62d02 data-v-cd0060b6><button data-v-cd0060b6>Return to top</button><!----></div></div><aside class="VPSidebar" data-v-bf985812 data-v-7abeb529><div class="curtain" data-v-7abeb529></div><nav class="nav" id="VPSidebarNav" aria-labelledby="sidebar-aria-label" tabindex="-1" data-v-7abeb529><span class="visually-hidden" id="sidebar-aria-label" data-v-7abeb529> Sidebar Navigation </span><!--[--><!--]--><!--[--><div class="group" data-v-7abeb529><div class="VPSidebarItem level-0" data-v-7abeb529 data-v-6bdc5fe9><div class="item" role="button" tabindex="0" data-v-6bdc5fe9><div class="indicator" data-v-6bdc5fe9></div><p class="text" data-v-6bdc5fe9>V8</p><!----></div><!----></div></div><div class="group" data-v-7abeb529><section class="VPSidebarItem level-0 has-active" data-v-7abeb529 data-v-6bdc5fe9><div class="item" role="button" tabindex="0" data-v-6bdc5fe9><div class="indicator" data-v-6bdc5fe9></div><h2 class="text" data-v-6bdc5fe9>指南：</h2><!----></div><div class="items" data-v-6bdc5fe9><!--[--><div class="VPSidebarItem level-1 is-link" data-v-6bdc5fe9 data-v-6bdc5fe9><div class="item" data-v-6bdc5fe9><div class="indicator" data-v-6bdc5fe9></div><a class="VPLink link link" href="/devops-doc/FE_Theory/V8/" data-v-6bdc5fe9><!--[--><p class="text" data-v-6bdc5fe9>简介</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-6bdc5fe9 data-v-6bdc5fe9><div class="item" data-v-6bdc5fe9><div class="indicator" data-v-6bdc5fe9></div><a class="VPLink link link" href="/devops-doc/FE_Theory/V8/%E6%89%A7%E8%A1%8C%E7%8E%AF%E5%A2%83.html" data-v-6bdc5fe9><!--[--><p class="text" data-v-6bdc5fe9>执行环境</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><!--]--><!--[--><!--]--></nav></aside><div class="VPContent has-sidebar" id="VPContent" data-v-bf985812 data-v-3bf59219><div class="VPDoc has-sidebar has-aside" data-v-3bf59219 data-v-0663733c><!--[--><!--]--><div class="container" data-v-0663733c><div class="aside" data-v-0663733c><div class="aside-curtain" data-v-0663733c></div><div class="aside-container" data-v-0663733c><div class="aside-content" data-v-0663733c><div class="VPDocAside" data-v-0663733c data-v-c195cc42><!--[--><!--]--><!--[--><!--]--><div class="VPDocAsideOutline" role="navigation" data-v-c195cc42 data-v-b14610c5><div class="content" data-v-b14610c5><div class="outline-marker" data-v-b14610c5></div><div class="outline-title" role="heading" data-v-b14610c5>本页目录</div><nav aria-labelledby="doc-outline-aria-label" data-v-b14610c5><span class="visually-hidden" id="doc-outline-aria-label" data-v-b14610c5> Table of Contents for current page </span><ul class="root" data-v-b14610c5 data-v-5ff4aa8f><!--[--><!--]--></ul></nav></div></div><!--[--><!--]--><div class="spacer" data-v-c195cc42></div><!--[--><!--]--><!----><!--[--><!--]--><!--[--><!--]--></div></div></div></div><div class="content" data-v-0663733c><div class="content-container" data-v-0663733c><!--[--><!--]--><!----><main class="main" data-v-0663733c><div style="position:relative;" class="vp-doc _devops-doc_FE_Theory_V8_%E6%89%A7%E8%A1%8C%E7%8E%AF%E5%A2%83" data-v-0663733c><div><h1 id="v8-执行环境" tabindex="-1">V8 执行环境 <a class="header-anchor" href="#v8-执行环境" aria-label="Permalink to &quot;V8 执行环境&quot;">​</a></h1><h2 id="惰性解析" tabindex="-1">惰性解析 <a class="header-anchor" href="#惰性解析" aria-label="Permalink to &quot;惰性解析&quot;">​</a></h2><blockquote><p><strong>惰性解析</strong>是指解析器在解析的过程中，如果遇到函数声明，那么会跳过函数内部的代码，并不会为其生成 AST 和字节码，而仅仅生成顶层代码的 AST 和字节码。</p></blockquote><p>在编译 JavaScript 代码的过程中，V8 并不会一次性将所有的 JavaScript 解析为中间代码，这主要是基于以下两点：</p><ol><li>首先，<strong>如果一次解析和编译所有的 JavaScript 代码</strong>，过多的代码会增加编译时间，这会严重影响到首次执行 JavaScript 代码的速度，让用户感觉到<strong>卡顿</strong>。因为有时候一个页面的 JavaScript 代码很大，如果要将所有的代码一次性解析编译完成，那么会大大增加用户的等待时间。</li><li>其次，解析完成的字节码和编译之后的机器代码都会存放在内存中，如果一次性解析和编译所有 JavaScript 代码，那么这些中间代码和机器代码将会一直<strong>占用内存</strong>。</li></ol><p>基于以上的原因，所有主流的 JavaScript 虚拟机都实现了惰性解析。</p><p><strong>闭包给惰性解析带来的问题</strong>：外部变量引用不能随着函数的执行上下文销毁而被销毁掉。</p><h2 id="预解析器" tabindex="-1">预解析器 <a class="header-anchor" href="#预解析器" aria-label="Permalink to &quot;预解析器&quot;">​</a></h2><blockquote><p>V8 引入<strong>预解析器</strong>，比如当解析顶层代码的时候，遇到了一个函数，那么预解析器并不会直接跳过该函数，而是对该函数做一次快速的预解析。</p></blockquote><ol><li>判断当前函数是不是存在一些语法上的错误，发现了语法错误，那么就会向 V8 抛出语法错误。</li><li>检查函数内部是否引用了外部变量，如果引用了外部的变量，预解析器会将栈中的变量复制到堆中，在下次执行到该函数的时候，直接使用堆中的引用，这样就解决了闭包所带来的问题。</li></ol><h2 id="隐藏类" tabindex="-1">隐藏类 <a class="header-anchor" href="#隐藏类" aria-label="Permalink to &quot;隐藏类&quot;">​</a></h2><blockquote><p>在 V8 中，<strong>每个对象都有一个 map 属性</strong>，该属性值指向该对象的隐藏类。不过<strong>如果两个对象的形状是相同的，V8 就会为其复用同一个隐藏类</strong>。</p></blockquote><p>这样有两个好处：</p><ul><li>减少隐藏类的创建次数，也间接加速了代码的执行速度。</li><li>减少了隐藏类的存储空间。</li></ul><p>那么，什么情况下两个对象的形状是相同的，要满足以下两点：</p><ul><li>相同的属性名称。</li><li>相等的属性个数。</li></ul><p>隐藏类将对象划分成不同的组，对于组内对象拥有相同的属性名和属性值的情况，将这些组的属性名和对应的偏移位置保存在一个隐藏类中，组内所有对象共享该信息。同时，也可以识别属性不同的对象。示例如下：</p><p><img src="/devops-doc/assets/隐藏类.b9981f70.webp" alt="img"></p><p>给一个对象添加新的属性，删除新的属性，或者改变某个属性的数据类型都会改变这个对象的形状，那么势必也就会触发 V8 为改变形状后的对象重建新的隐藏类。</p><h3 id="内联缓存" tabindex="-1">内联缓存 <a class="header-anchor" href="#内联缓存" aria-label="Permalink to &quot;内联缓存&quot;">​</a></h3><blockquote><p>正常访问对象属性的过程是：首先获取隐藏类的地址，然后根据属性名查找偏移值，然后计算该属性的地址。虽然相比以往在整个执行环境中查找减小了很大的工作量，但依然比较耗时。能不能将之前查询的结果缓存起来，供再次访问呢？当然是可行的，这就是内嵌缓存 <strong>(Inline Cache)</strong>，简称为 IC。</p></blockquote><ul><li>在 V8 执行函数的过程中，会观察函数中一些<strong>调用点 (CallSite)</strong> 上的关键中间数据，然后将这些数据缓存起来，当下次再次执行该函数的时候，V8 就可以直接利用这些中间数据，节省了再次获取这些数据的过程，因此 V8 利用 IC，可以有效提升一些重复代码的执行效率。</li><li>IC 会为每个函数维护一个<strong>反馈向量 (FeedBack Vector)</strong>，反馈向量记录了函数在执行过程中的一些关键的中间数据。</li><li>反馈向量其实就是一个表结构，它由很多项组成的，每一项称为一个插槽 (Slot)，V8 会依次将执行 loadX 函数的中间数据写入到反馈向量的插槽中。</li><li>当 V8 再次调用 loadX 函数时，比如执行到 loadX 函数中的 return obj.x 语句时，它就会在对应的插槽中查找 x 属性的偏移量，之后 V8 就能直接去内存中获取 obj.x 的属性值了。这样就大大提升了 V8 的执行效率。</li></ul><h3 id="单态、多态和超态" tabindex="-1">单态、多态和超态 <a class="header-anchor" href="#单态、多态和超态" aria-label="Permalink to &quot;单态、多态和超态&quot;">​</a></h3><ul><li>如果一个插槽中只包含 1 个隐藏类，那么我们称这种状态为单态 (monomorphic)；</li><li>如果一个插槽中包含了 2 ～ 4 个隐藏类，那我们称这种状态为多态 (polymorphic)；</li><li>如果一个插槽中超过 4 个隐藏类，那我们称这种状态为超态 (magamorphic)。</li><li>单态的性能优于多态和超态，所以我们需要稍微避免多态和超态的情况。要避免多态和超态，那么就尽量默认所有的对象属性是不变的，比如你写了一个 loadX(obj) 的函数，那么当传递参数时，尽量不要使用多个不同形状的 obj 对象。</li></ul><h2 id="优化回滚" tabindex="-1">优化回滚 <a class="header-anchor" href="#优化回滚" aria-label="Permalink to &quot;优化回滚&quot;">​</a></h2><blockquote><p>因为 V8 是基于 AST 直接生成本地代码，没有经过中间表示层的优化，所以本地代码尚未经过很好的优化。于是，在 2010 年，V8 引入了新的编译器-Crankshaft，它主要针对热点函数进行优化，基于 JavaScript 源代码开始分析而非本地代码，同时构建 Hydroger 图并基于此来进行优化分析。</p></blockquote><p>Crankshaft 编译器为了性能考虑，通常会做出比较乐观和大胆的预测—代码稳定且变量类型不变，所以可以生成高效的本地代码。但是，鉴于 JavaScript 的一个弱类型的语言，变量类型也可能在执行的过程中进行改变，鉴于这种情况，V8 会将该编译器做的想当然的优化进行回滚，称为优化回滚。</p><p>该函数被调用多次之后，V8 引擎可能会触发 Crankshaft 编译器对其进行优化，而优化代码认为示例代码的类型信息都已经被确定。但，由于尚未真正执行到 new Date()这个地方，并未获取 unknown 这个变量的类型，V8 只得将该部分代码进行回滚。优化回滚是一个很耗时的操作，在写代码过程中，尽量不要触发优化该操作。</p><p>在最近发布的 V8 5.9 版本中，新增了一个 Ignition 字节码解释器，TurboFan 和 Ignition 结合起来共同完成 JavaScript 的编译。这个版本中消除 Cranshaft 这个旧的编译器，并让新的 Turbofan 直接从字节码来优化代码，并当需要进行反优化的时候直接反优化到字节码，而不需要再考虑 JS 源代码。</p><h2 id="内部存储对象形式" tabindex="-1">内部存储对象形式 <a class="header-anchor" href="#内部存储对象形式" aria-label="Permalink to &quot;内部存储对象形式&quot;">​</a></h2><blockquote><p>在<a href="https://link.zhihu.com/?target=https%3A//link.segmentfault.com/%3Fenc%3D3ZZ0dumlISZGkYNJUNpHAA%3D%3D.Z9kiu6V9GNFz3bo8rtc0hyws7wC%2FnbwqyM6tWWK27tc6nAVdEif4oXPoeZaxiYvMjj9ZDVIFfwG%2BSl%2F5jHyCtg%3D%3D" target="_blank" rel="noreferrer">ECMAScript 规范</a>中定义了<strong>数字属性应该按照索引值大小升序排列，字符串属性根据创建时的顺序升序排列</strong>。在这里我们把对象中的数字属性称为<strong>排序属性</strong>，在 V8 中被称为 elements，字符串属性就被称为<strong>常规属性</strong>，在 V8 中被称为 properties。在 V8 内部，为了有效地提升存储和访问这两种属性的性能，分别使用了两个线性数据结构来分别保存排序属性和常规属性。同时 v8 将部分常规属性直接存储到对象本身，我们把这称为<strong>对象内属性 (in-object properties)</strong>，不过对象内属性的数量是固定的，默认是 10 个。</p></blockquote><p>JavaScript 中的对象是由一组组属性和值组成的，所以最简单的方式是使用一个字典来保存属性和值，但是由于字典是非线性结构，所以如果使用字典，读取效率会大大降低。为了提升查找效率，<strong>V8 在对象中添加了两个隐藏属性，排序属性和常规属性</strong>，element 属性指向了 elements 对象，在 elements 对象中，会按照顺序存放排序属性。properties 属性则指向了 properties 对象，在 properties 对象中，会按照创建时的顺序保存常规属性。</p><p>保存在线性数据结构中的属性称之为“<strong>快属性</strong>”，因为线性数据结构中只需要通过索引即可以访问到属性，虽然访问线性结构的速度快，但是<strong>如果从线性结构中添加或者删除大量的属性时，则执行效率会非常低，这主要因为会产生大量时间和内存开销</strong>。</p><p>因此，如果一个对象的属性过多时，V8 就会采取另外一种存储策略，那就是“<strong>慢属性</strong>”策略，但慢属性的对象内部会有独立的非线性数据结构 (字典) 作为属性存储容器。所有的属性元信息不再是线性存储的，而是直接保存在属性字典中。</p><p>通过引入这两个属性，加速了 V8 查找属性的速度，为了更加进一步提升查找效率，V8 还实现了内置内属性的策略，当常规属性少于一定数量时，V8 就会将这些常规属性直接写进对象中，这样又节省了一个中间步骤。</p><p><strong>如果对象中的属性过多时，或者存在反复添加或者删除属性的操作，那么 V8 就会将线性的存储模式降级为非线性的字典存储模式，这样虽然降低了查找速度，但是却提升了修改对象的属性的速度</strong>。</p><p><img src="/devops-doc/assets/V8内部存储对象形式.c59bf278.webp" alt="img"></p><h2 id="堆和栈空间" tabindex="-1">堆和栈空间 <a class="header-anchor" href="#堆和栈空间" aria-label="Permalink to &quot;堆和栈空间&quot;">​</a></h2><h3 id="栈空间" tabindex="-1">栈空间 <a class="header-anchor" href="#栈空间" aria-label="Permalink to &quot;栈空间&quot;">​</a></h3><blockquote><p>现代语言都是基于函数的，每个函数在执行过程中，都有自己的生命周期和作用域，当函数执行结束时，其作用域也会被销毁，因此，我们会使用栈这种数据结构来管理函数的调用过程，我们也把管理函数调用过程的栈结构称之为<strong>调用栈</strong>。</p><p><strong>栈空间</strong>主要是用来管理 JavaScript 函数调用的，栈是内存中连续的一块空间，同时栈结构是“先进后出”的策略。在函数调用过程中，涉及到上下文相关的内容都会存放在栈上，比如原生类型、引用到的对象的地址、函数的执行状态、this 值等都会存在在栈上。当一个函数执行结束，那么该函数的执行上下文便会被销毁掉。</p><p><strong>栈空间的最大的特点是空间连续</strong>，所以在栈中每个元素的地址都是固定的，因此栈空间的查找效率非常高，但是通常在内存中，很难分配到一块很大的连续空间，因此，V8 对栈空间的大小做了限制，如果函数调用层过深，那么 V8 就有可能抛出栈溢出的错误。</p></blockquote><h3 id="堆空间" tabindex="-1">堆空间 <a class="header-anchor" href="#堆空间" aria-label="Permalink to &quot;堆空间&quot;">​</a></h3><blockquote><p><strong>堆空间</strong>是一种<strong>树</strong>形的存储结构，<strong>用来存储对象类型的离散的数据</strong>，JavaScript 中除了原生类型的数据，其他的都是对象类型，诸如函数、数组，在浏览器中还有 window 对象、document 对象等，这些都是存在堆空间的。</p></blockquote><h3 id="闭包" tabindex="-1">闭包 <a class="header-anchor" href="#闭包" aria-label="Permalink to &quot;闭包&quot;">​</a></h3><blockquote><p>在内部函数中访问父函数中定义的变量的现象称为闭包。</p><p>因为 JavaScript 中的函数是一等公民，所以允许在函数内部定义新的函数并作为另外一个函数的返回值。而通过在堆内存中创建闭包所引用值的引用对象，使得后续执行上下文可以访问到闭包的值。</p></blockquote><h2 id="静态作用域与动态作用域" tabindex="-1">静态作用域与动态作用域 <a class="header-anchor" href="#静态作用域与动态作用域" aria-label="Permalink to &quot;静态作用域与动态作用域&quot;">​</a></h2><h3 id="静态作用域" tabindex="-1">静态作用域 <a class="header-anchor" href="#静态作用域" aria-label="Permalink to &quot;静态作用域&quot;">​</a></h3><blockquote><p>如果一门语言的作用域是<strong>静态作用域</strong>，那么<strong>符号之间的引用关系能够根据程序代码在编译时就确定清楚，在运行时不会变</strong>。某个函数是在哪声明的，就具有它所在位置的作用域。它能够访问哪些变量，那么就跟这些变量绑定了，在运行时就一直能访问这些变量。即静态作用域可以由程序代码决定，在编译时就能完全确定。大多数语言都是静态作用域的。</p></blockquote><h3 id="动态作用域" tabindex="-1">动态作用域 <a class="header-anchor" href="#动态作用域" aria-label="Permalink to &quot;动态作用域&quot;">​</a></h3><blockquote><p><strong>动态作用域（Dynamic Scope）</strong>。也就是说，变量引用跟变量声明不是在编译时就绑定死了的。在运行时，它是在运行环境中动态地找一个相同名称的变量。在 macOS 或 Linux 中用的 bash 脚本语言，就是动态作用域的。</p></blockquote><h2 id="执行上下文" tabindex="-1">执行上下文 <a class="header-anchor" href="#执行上下文" aria-label="Permalink to &quot;执行上下文&quot;">​</a></h2><blockquote><p>执行上下文是评估和执行 JavaScript 代码的环境的抽象概念。每当 Javascript 代码在运行的时候，它都是在执行上下文中运行。</p></blockquote><table><thead><tr><th style="text-align:right;">Classify</th><th>Discription</th></tr></thead><tbody><tr><td style="text-align:right;"><code>ES3 组成</code></td><td></td></tr><tr><td style="text-align:right;"><strong>scope</strong></td><td>作用域，也常常被叫做作用域链。</td></tr><tr><td style="text-align:right;"><strong>variable object</strong></td><td>变量对象，用于存储变量的对象。</td></tr><tr><td style="text-align:right;"><strong>this value</strong></td><td>this 值。</td></tr><tr><td style="text-align:right;"><code>ES5 组成</code></td><td></td></tr><tr><td style="text-align:right;"><strong>lexical environment</strong></td><td>词法环境，当获取变量时使用。</td></tr><tr><td style="text-align:right;"><strong>variable environment</strong></td><td>变量环境，当声明变量时使用。</td></tr><tr><td style="text-align:right;"><strong>this value</strong></td><td>this 值。</td></tr><tr><td style="text-align:right;"><code>ES2018 组成</code></td><td></td></tr><tr><td style="text-align:right;"><strong>lexical environment</strong></td><td>词法环境，当获取变量或者 this 值时使用。</td></tr><tr><td style="text-align:right;"><strong>variable environment</strong></td><td>变量环境，当声明变量时使用</td></tr><tr><td style="text-align:right;"><strong>code evaluation state</strong></td><td>用于恢复代码执行位置。</td></tr><tr><td style="text-align:right;"><strong>Function</strong></td><td>执行的任务是函数时使用，表示正在被执行的函数。</td></tr><tr><td style="text-align:right;"><strong>ScriptOrModule</strong></td><td>执行的任务是脚本或者模块时使用，表示正在被执行的代码。</td></tr><tr><td style="text-align:right;"><strong>Realm</strong></td><td>使用的基础库和内置对象实例。</td></tr><tr><td style="text-align:right;"><strong>Generator</strong></td><td>仅生成器上下文有这个属性，表示当前生成器。</td></tr></tbody></table><h3 id="执行上下文类型" tabindex="-1">执行上下文类型 <a class="header-anchor" href="#执行上下文类型" aria-label="Permalink to &quot;执行上下文类型&quot;">​</a></h3><ul><li><p><strong>全局执行上下文</strong> — 这是默认或者说基础的上下文，任何不在函数内部的代码都在全局上下文中。它会执行两件事：创建一个全局的 window 对象（浏览器的情况下），并且设置 <code>this</code> 的值等于这个全局对象。一个程序中只会有一个全局执行上下文。</p></li><li><p><strong>函数执行上下文</strong> — 每当一个函数被调用时, 都会为该函数创建一个新的上下文。每个函数都有它自己的执行上下文，不过是在函数被调用时创建的。函数上下文可以有任意多个。每当一个新的执行上下文被创建，它会按定义的顺序（将在后文讨论）执行一系列步骤。</p></li><li><p><strong>Eval 函数执行上下文</strong> — 执行在 <code>eval</code> 函数内部的代码也会有它属于自己的执行上下文，但由于 JavaScript 开发者并不经常使用 <code>eval</code>，所以在这里我不会讨论它。</p></li></ul><h3 id="执行栈" tabindex="-1">执行栈 <a class="header-anchor" href="#执行栈" aria-label="Permalink to &quot;执行栈&quot;">​</a></h3><blockquote><p>执行栈，也就是在其它编程语言中所说的“调用栈”，是一种拥有 LIFO（后进先出）数据结构的栈，被用来存储代码运行时创建的所有执行上下文。</p></blockquote><p>当 JavaScript 引擎第一次遇到你的脚本时，它会创建一个全局的执行上下文并且压入当前执行栈。每当引擎遇到一个函数调用，它会为该函数创建一个新的执行上下文并压入栈的顶部。</p><p>引擎会执行那些执行上下文位于栈顶的函数。当该函数执行结束时，执行上下文从栈中弹出，控制流程到达当前栈中的下一个上下文。</p><h3 id="创建阶段" tabindex="-1">创建阶段 <a class="header-anchor" href="#创建阶段" aria-label="Permalink to &quot;创建阶段&quot;">​</a></h3><ol><li><strong>this</strong> 值的决定，即 <strong>This 绑定</strong>。</li><li>创建<strong>词法环境</strong>组件。</li><li>创建<strong>变量环境</strong>组件。</li></ol><h4 id="this-绑定" tabindex="-1">This 绑定 <a class="header-anchor" href="#this-绑定" aria-label="Permalink to &quot;This 绑定&quot;">​</a></h4><blockquote><p>在全局执行上下文中，<code>this</code> 的值指向全局对象。(在浏览器中，<code>this</code>引用 Window 对象)。</p><p>在函数执行上下文中，<code>this</code> 的值取决于该函数是如何被调用的。如果它被一个引用对象调用，那么 <code>this</code> 会被设置成那个对象，否则 <code>this</code> 的值被设置为全局对象或者 <code>undefined</code>（在严格模式下）。</p></blockquote><h4 id="词法环境" tabindex="-1">词法环境 <a class="header-anchor" href="#词法环境" aria-label="Permalink to &quot;词法环境&quot;">​</a></h4><blockquote><p><strong>词法环境</strong>是一种规范类型，基于 ECMAScript 代码的词法嵌套结构来定义<strong>标识符</strong>和具体变量和函数的关联。一个词法环境由环境记录器和一个可能的引用<strong>外部</strong>词法环境的空值组成。</p><p>简单来说<strong>词法环境</strong>是一种持有<strong>标识符—变量映射</strong>的结构。（这里的<strong>标识符</strong>指的是变量/函数的名字，而<strong>变量</strong>是对实际对象[包含函数类型对象]或原始数据的引用）。</p></blockquote><table><thead><tr><th style="text-align:right;">词法环境类型</th><th>描述</th></tr></thead><tbody><tr><td style="text-align:right;"><strong>全局环境</strong></td><td>（在全局执行上下文中）是没有外部环境引用的词法环境。全局环境的外部环境引用是 <strong>null</strong>。<br>它拥有内建的 Object/Array/等、在环境记录器内的原型函数（关联全局对象，比如 window 对象）还有任何用户定义的全局变量<br>并且 <code>this</code>的值指向全局对象。</td></tr><tr><td style="text-align:right;"><strong>函数环境</strong></td><td>函数内部用户定义的变量存储在<strong>环境记录器</strong>中。并且引用的外部环境可能是全局环境，或者任何包含此内部函数的外部函数。</td></tr></tbody></table><table><thead><tr><th style="text-align:right;">词法环境组成</th><th>描述</th></tr></thead><tbody><tr><td style="text-align:right;"><strong>环境记录器</strong></td><td>存储变量和函数声明的实际位置。</td></tr><tr><td style="text-align:right;"><strong>外部环境的引用</strong></td><td>它可以访问其父级词法环境<code>（作用域）</code>。</td></tr></tbody></table><table><thead><tr><th style="text-align:right;">词法环境类型</th><th>描述</th></tr></thead><tbody><tr><td style="text-align:right;"><strong>对象环境记录器</strong></td><td>用来定义出现在<strong>全局上下文</strong>中的变量和函数的关系。</td></tr><tr><td style="text-align:right;"><strong>声明式环境记录器</strong></td><td>存储变量、函数和参数。<br>函数环境下还包括一个传递给函数的 <code>arguments</code> 对象（此对象存储索引和参数的映射）和传递给函数的参数的 <strong>length</strong>。</td></tr></tbody></table><p><code>总结：</code></p><ul><li>在<strong>全局环境</strong>中，环境记录器是对象环境记录器。</li><li>在<strong>函数环境</strong>中，环境记录器是声明式环境记录器。</li></ul><div class="language-js vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">// 词法环境伪代码</span></span>
<span class="line"><span style="color:#E1E4E8;">GlobalExectionContext </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">  LexicalEnvironment: {</span></span>
<span class="line"><span style="color:#E1E4E8;">    EnvironmentRecord: {</span></span>
<span class="line"><span style="color:#E1E4E8;">      Type: </span><span style="color:#9ECBFF;">&quot;Object&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#6A737D;">// 在这里绑定标识符</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">    outer: &lt;</span><span style="color:#85E89D;">null</span><span style="color:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">FunctionExectionContext = {</span></span>
<span class="line"><span style="color:#E1E4E8;">  LexicalEnvironment: {</span></span>
<span class="line"><span style="color:#E1E4E8;">    EnvironmentRecord: {</span></span>
<span class="line"><span style="color:#E1E4E8;">      Type: </span><span style="color:#9ECBFF;">&quot;Declarative&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#6A737D;">// 在这里绑定标识符</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">    outer: &lt;</span><span style="color:#79B8FF;">Global</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">or</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">outer</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">function</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">environment</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">reference</span><span style="color:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">// 词法环境伪代码</span></span>
<span class="line"><span style="color:#24292E;">GlobalExectionContext </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">  LexicalEnvironment: {</span></span>
<span class="line"><span style="color:#24292E;">    EnvironmentRecord: {</span></span>
<span class="line"><span style="color:#24292E;">      Type: </span><span style="color:#032F62;">&quot;Object&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#6A737D;">// 在这里绑定标识符</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">    outer: &lt;</span><span style="color:#22863A;">null</span><span style="color:#24292E;">&gt;</span></span>
<span class="line"><span style="color:#24292E;">  }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">FunctionExectionContext = {</span></span>
<span class="line"><span style="color:#24292E;">  LexicalEnvironment: {</span></span>
<span class="line"><span style="color:#24292E;">    EnvironmentRecord: {</span></span>
<span class="line"><span style="color:#24292E;">      Type: </span><span style="color:#032F62;">&quot;Declarative&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#6A737D;">// 在这里绑定标识符</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">    outer: &lt;</span><span style="color:#005CC5;">Global</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">or</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">outer</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">function</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">environment</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">reference</span><span style="color:#24292E;">&gt;</span></span>
<span class="line"><span style="color:#24292E;">  }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><h4 id="变量环境" tabindex="-1">变量环境 <a class="header-anchor" href="#变量环境" aria-label="Permalink to &quot;变量环境&quot;">​</a></h4><blockquote><p>它同样是一个词法环境，其环境记录器持有<strong>变量声明语句</strong>在执行上下文中创建的绑定关系。</p><p>如上所述，变量环境也是一个词法环境，所以它有着上面定义的词法环境的所有属性。</p><p>在 ES6 中，<strong>词法环境</strong>组件和<strong>变量环境</strong>的一个不同就是前者被用来存储函数声明和变量（<code>let</code> 和 <code>const</code>）绑定，而后者只用来存储 <code>var</code> 变量绑定。</p></blockquote><div class="language-js vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">// 执行上下文伪代码</span></span>
<span class="line"><span style="color:#E1E4E8;">GlobalExectionContext </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">  ThisBinding: &lt;</span><span style="color:#79B8FF;">Global</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Object</span><span style="color:#E1E4E8;">&gt;,</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">  LexicalEnvironment: {</span></span>
<span class="line"><span style="color:#E1E4E8;">    EnvironmentRecord: {</span></span>
<span class="line"><span style="color:#E1E4E8;">      Type: </span><span style="color:#9ECBFF;">&quot;Object&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#6A737D;">// 在这里绑定标识符</span></span>
<span class="line"><span style="color:#E1E4E8;">      a: &lt; </span><span style="color:#85E89D;">uninitialized</span><span style="color:#E1E4E8;"> &gt;,</span></span>
<span class="line"><span style="color:#E1E4E8;">      b: &lt; </span><span style="color:#85E89D;">uninitialized</span><span style="color:#E1E4E8;"> &gt;,</span></span>
<span class="line"><span style="color:#E1E4E8;">      multiply: &lt; </span><span style="color:#85E89D;">func</span><span style="color:#E1E4E8;"> &gt;</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">    outer: &lt;</span><span style="color:#85E89D;">null</span><span style="color:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="color:#E1E4E8;">  },</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">  VariableEnvironment: {</span></span>
<span class="line"><span style="color:#E1E4E8;">    EnvironmentRecord: {</span></span>
<span class="line"><span style="color:#E1E4E8;">      Type: </span><span style="color:#9ECBFF;">&quot;Object&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#6A737D;">// 在这里绑定标识符</span></span>
<span class="line"><span style="color:#E1E4E8;">      c: </span><span style="color:#79B8FF;">undefined</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">    outer: &lt;</span><span style="color:#85E89D;">null</span><span style="color:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">FunctionExectionContext = {</span></span>
<span class="line"><span style="color:#E1E4E8;">  ThisBinding: &lt;</span><span style="color:#79B8FF;">Global</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Object</span><span style="color:#E1E4E8;">&gt;,</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">  LexicalEnvironment: {</span></span>
<span class="line"><span style="color:#E1E4E8;">    EnvironmentRecord: {</span></span>
<span class="line"><span style="color:#E1E4E8;">      Type: </span><span style="color:#9ECBFF;">&quot;Declarative&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#6A737D;">// 在这里绑定标识符</span></span>
<span class="line"><span style="color:#E1E4E8;">      Arguments: {</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">20</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">30</span><span style="color:#E1E4E8;">, length: </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">},</span></span>
<span class="line"><span style="color:#E1E4E8;">    },</span></span>
<span class="line"><span style="color:#E1E4E8;">    outer: &lt;</span><span style="color:#79B8FF;">GlobalLexicalEnvironment</span><span style="color:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="color:#E1E4E8;">  },</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">VariableEnvironment: {</span></span>
<span class="line"><span style="color:#E1E4E8;">    EnvironmentRecord: {</span></span>
<span class="line"><span style="color:#E1E4E8;">      Type: </span><span style="color:#9ECBFF;">&quot;Declarative&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#6A737D;">// 在这里绑定标识符</span></span>
<span class="line"><span style="color:#E1E4E8;">      g: </span><span style="color:#79B8FF;">undefined</span></span>
<span class="line"><span style="color:#E1E4E8;">    },</span></span>
<span class="line"><span style="color:#E1E4E8;">    outer: &lt;</span><span style="color:#79B8FF;">GlobalLexicalEnvironment</span><span style="color:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">// 执行上下文伪代码</span></span>
<span class="line"><span style="color:#24292E;">GlobalExectionContext </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">  ThisBinding: &lt;</span><span style="color:#005CC5;">Global</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Object</span><span style="color:#24292E;">&gt;,</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">  LexicalEnvironment: {</span></span>
<span class="line"><span style="color:#24292E;">    EnvironmentRecord: {</span></span>
<span class="line"><span style="color:#24292E;">      Type: </span><span style="color:#032F62;">&quot;Object&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#6A737D;">// 在这里绑定标识符</span></span>
<span class="line"><span style="color:#24292E;">      a: &lt; </span><span style="color:#22863A;">uninitialized</span><span style="color:#24292E;"> &gt;,</span></span>
<span class="line"><span style="color:#24292E;">      b: &lt; </span><span style="color:#22863A;">uninitialized</span><span style="color:#24292E;"> &gt;,</span></span>
<span class="line"><span style="color:#24292E;">      multiply: &lt; </span><span style="color:#22863A;">func</span><span style="color:#24292E;"> &gt;</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">    outer: &lt;</span><span style="color:#22863A;">null</span><span style="color:#24292E;">&gt;</span></span>
<span class="line"><span style="color:#24292E;">  },</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">  VariableEnvironment: {</span></span>
<span class="line"><span style="color:#24292E;">    EnvironmentRecord: {</span></span>
<span class="line"><span style="color:#24292E;">      Type: </span><span style="color:#032F62;">&quot;Object&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#6A737D;">// 在这里绑定标识符</span></span>
<span class="line"><span style="color:#24292E;">      c: </span><span style="color:#005CC5;">undefined</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">    outer: &lt;</span><span style="color:#22863A;">null</span><span style="color:#24292E;">&gt;</span></span>
<span class="line"><span style="color:#24292E;">  }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">FunctionExectionContext = {</span></span>
<span class="line"><span style="color:#24292E;">  ThisBinding: &lt;</span><span style="color:#005CC5;">Global</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Object</span><span style="color:#24292E;">&gt;,</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">  LexicalEnvironment: {</span></span>
<span class="line"><span style="color:#24292E;">    EnvironmentRecord: {</span></span>
<span class="line"><span style="color:#24292E;">      Type: </span><span style="color:#032F62;">&quot;Declarative&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#6A737D;">// 在这里绑定标识符</span></span>
<span class="line"><span style="color:#24292E;">      Arguments: {</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">20</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">30</span><span style="color:#24292E;">, length: </span><span style="color:#005CC5;">2</span><span style="color:#24292E;">},</span></span>
<span class="line"><span style="color:#24292E;">    },</span></span>
<span class="line"><span style="color:#24292E;">    outer: &lt;</span><span style="color:#005CC5;">GlobalLexicalEnvironment</span><span style="color:#24292E;">&gt;</span></span>
<span class="line"><span style="color:#24292E;">  },</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">VariableEnvironment: {</span></span>
<span class="line"><span style="color:#24292E;">    EnvironmentRecord: {</span></span>
<span class="line"><span style="color:#24292E;">      Type: </span><span style="color:#032F62;">&quot;Declarative&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#6A737D;">// 在这里绑定标识符</span></span>
<span class="line"><span style="color:#24292E;">      g: </span><span style="color:#005CC5;">undefined</span></span>
<span class="line"><span style="color:#24292E;">    },</span></span>
<span class="line"><span style="color:#24292E;">    outer: &lt;</span><span style="color:#005CC5;">GlobalLexicalEnvironment</span><span style="color:#24292E;">&gt;</span></span>
<span class="line"><span style="color:#24292E;">  }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><p><code>TIP</code></p><ul><li>只有遇到调用函数时，函数执行上下文才会被创建。</li><li>在创建阶段时，引擎检查代码找出变量和函数声明，虽然函数声明完全存储在环境中，但是变量最初设置为 <code>undefined</code>（<code>var</code> 情况下），或者未初始化（<code>let</code> 和 <code>const</code> 情况下）。</li><li>这就是为什么你可以在声明之前访问 <code>var</code> 定义的变量（虽然是 <code>undefined</code>），但是在声明之前访问 <code>let</code> 和 <code>const</code> 的变量会得到一个引用错误。也被称为变量提升。</li></ul><h3 id="执行阶段" tabindex="-1">执行阶段 <a class="header-anchor" href="#执行阶段" aria-label="Permalink to &quot;执行阶段&quot;">​</a></h3><blockquote><p>在此阶段，完成对所有这些变量的分配，最后执行代码。</p></blockquote><h2 id="事件循环系统" tabindex="-1">事件循环系统 <a class="header-anchor" href="#事件循环系统" aria-label="Permalink to &quot;事件循环系统&quot;">​</a></h2><h3 id="v8-是如何执行回调函数" tabindex="-1">V8 是如何执行回调函数 <a class="header-anchor" href="#v8-是如何执行回调函数" aria-label="Permalink to &quot;V8 是如何执行回调函数&quot;">​</a></h3><blockquote><p>回调函数有两种类型：同步回调和异步回调，同步回调函数是在执行函数内部被执行的，而异步回调函数是在执行函数外部被执行的。</p><p>UI 线程提供一个<strong>消息队列</strong>，并将待执行的事件添加到消息队列中，然后 UI 线程会不断循环地从消息队列中取出事件、执行事件。</p><p>通用 UI 线程宏观架构：</p></blockquote><p><img src="/devops-doc/assets/通用UI线程宏观架构.d9017a93.webp" alt="img"></p><h3 id="事件循环系统构成" tabindex="-1">事件循环系统构成 <a class="header-anchor" href="#事件循环系统构成" aria-label="Permalink to &quot;事件循环系统构成&quot;">​</a></h3><blockquote><ul><li>主线程：UI 线程。</li><li>调用栈：一种数据结构、用来管理在主线程上执行的函数的调用关系。主线程在执行任务的过程中，如果函数的调用层次过深，可能造成栈溢出的错误，</li><li>消息队列：用于存放等待主线程执行的宏任务 ‘事件’列表。</li><li>任务：UI 线程每次从消息队列中取出事件、执行事件的过程称为一次任务。</li><li>宏任务：指消息队列中的等待被主线程执行的事件。每个宏任务在执行时，V8 都会重新创建栈，然后随着宏任务中函数调用，栈也随之变化，最终，当该宏任务执行结束时，整个栈又会被清空，接着主线程继续执行下一个宏任务。</li><li>微任务：一个需要异步执行的函数、执行的时机在主线程执行结束之后、当前宏任务结束之前。</li></ul></blockquote><p><img src="/devops-doc/assets/微任务.a318406c.webp" alt="img"></p><p>常见宏任务有：<strong>主 js、UI 渲染</strong>、setTimeout、setInterval、setImmediately、requestAnimationFrame、I/O 等</p><p>常见微任务有：process.nextTick()、promise.then()、Object.observe()等</p><p><strong>JavaScript 中之所以要引入微任务，主要是由于主线程执行消息队列中宏任务的时间颗粒度太粗了，无法胜任一些对精度和实时性要求较高的场景，微任务可以在实时性和效率之间做一个有效的权衡</strong>。另外使用微任务，可以改变我们现在的异步编程模型，使得我们可以使用同步形式的代码来编写异步调用。</p><p>微任务是基于消息队列、事件循环、UI 主线程还有堆栈而来的，然后基于微任务，又可以延伸出协程、Promise、Generator、await/async 等现代前端经常使用的一些技术。</p><p><img src="/devops-doc/assets/事件循环系统构成.efedec12.png" alt="img"></p><p>如果当前的任务中产生了一个微任务，通过 Promise.resolve() 或者 Promise.reject() 都会触发微任务，触发的微任务不会在当前的函数中被执行，所以<strong>执行微任务时，不会导致栈的无限扩张</strong></p><p>和异步调用不同，微任务依然会在当前任务执行结束之前被执行，这也就意味着<strong>在当前微任务执行结束之前，消息队列中的其他任务是不可能被执行的</strong>。因此在函数内部触发的微任务，一定比在函数内部触发的宏任务要优先执行。</p><p>微任务依然是在当前的任务中执行的，所以如果在微任务中循环触发新的微任务，那么将导致消息队列中的其他任务没有机会被执行。</p><h3 id="前端异步编程方案史" tabindex="-1">前端异步编程方案史 <a class="header-anchor" href="#前端异步编程方案史" aria-label="Permalink to &quot;前端异步编程方案史&quot;">​</a></h3><p><img src="/devops-doc/assets/前端异步编程方案史.c599b11d.webp" alt="img"></p><p><strong>Callback 模式的异步编程模型</strong>需要实现大量的回调函数，大量的回调函数会打乱代码的正常逻辑，使得代码变得不线性、不易阅读，这就是我们所说的<strong>回调地狱问题</strong>。</p><p><strong>Promise</strong> 能很好地解决回调地狱的问题，我们可以按照线性的思路来编写代码，这个过程是线性的，非常符合人的直觉。</p><p>但是这种方式<strong>充满了 Promise 的 then() 方法</strong>，如果处理流程比较复杂的话，那么整段代码将<strong>充斥着大量的 then，语义化不明显，代码不能很好地表示执行流程</strong>。我们想要通过<strong>线性的方式</strong>来编写异步代码，要实现这个理想，<strong>最关键的是要能实现函数暂停和恢复执行的功能</strong>。而<strong>生成器</strong>就可以实现函数暂停和恢复，我们可以在生成器中使用同步代码的逻辑来异步代码 (实现该逻辑的核心是协程)。</p><p>但是在生成器之外，我们还需要一个<strong>触发器</strong>来驱动生成器的执行。前端的最终方案就是 async/await，async 是一个可以暂停和恢复执行的函数，在 async 函数内部使用 await 来暂停 async 函数的执行，await 等待的是一个 Promise 对象，如果 Promise 的状态变成 resolve 或者 reject，那么 async 函数会恢复执行。因此，使用 async/await 可以实现以同步的方式编写异步代码这一目标。和生成器函数一样，使用了 async 声明的函数在执行时，也是一个单独的协程，我们可以使用 await 来暂停该协程，由于 await 等待的是一个 Promise 对象，我们可以 resolve 来恢复该协程。</p><h2 id="垃圾回收" tabindex="-1">垃圾回收 <a class="header-anchor" href="#垃圾回收" aria-label="Permalink to &quot;垃圾回收&quot;">​</a></h2><h3 id="代际假说" tabindex="-1">代际假说 <a class="header-anchor" href="#代际假说" aria-label="Permalink to &quot;代际假说&quot;">​</a></h3><blockquote><p>在垃圾回收中有一个重要的术语：“代际假说”；代际假说表明很多对象在内存中存在的时间很短。换句话说，从垃圾回收的角度来看，很多对象一经分配内存空间随即就变成了不可访问的。这个假说不仅仅适用于 V8 和 JavaScript。</p></blockquote><p>代际假说有以下两个特点：</p><ol><li>大部分对象在内存中存在的时间很短，简单来说，就是很多对象一经分配内存，很快就变得不可访问。</li><li>不死的对象，会活得更久。</li></ol><h3 id="分代堆布局" tabindex="-1">分代堆布局 <a class="header-anchor" href="#分代堆布局" aria-label="Permalink to &quot;分代堆布局&quot;">​</a></h3><blockquote><p>堆在 V8 中会分为两块不同的区域，这两块区域分别称之为老生代和新生代，新生代又进一步分为 ‘nursery’（from-space） 子代和 ‘intermediate’ (to-space)子代两块区域。</p><p>一个对象第一次分配内存时会被分配到新生代中的‘from-space’ 子代；如果进过下一次垃圾回收这个对象还存在新生代中，这时候我们移动到 ‘to-space’ 子代，再经过下一次垃圾回收这个对象还在新生代，这时候我们就会把这个对象移动到老生代。</p></blockquote><h3 id="javascript-的内存管理" tabindex="-1">JavaScript 的内存管理 <a class="header-anchor" href="#javascript-的内存管理" aria-label="Permalink to &quot;JavaScript 的内存管理&quot;">​</a></h3><p>不管什么程序语言，内存生命周期基本是一致的：</p><ol><li>分配你所需要的内存</li><li>使用分配到的内存（读、写）</li><li>不需要时将其释放|归还</li></ol><p>与其他需要手动管理内存的语言不通，在 JavaScript 中，当我们创建变量（对象，字符串等）的时候，系统会自动给对象分配对应的内存。</p><div class="language-js vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">var</span><span style="color:#E1E4E8;"> n </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">123</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;">// 给数值变量分配内存</span></span>
<span class="line"><span style="color:#F97583;">var</span><span style="color:#E1E4E8;"> s </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;azerty&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;">// 给字符串分配内存</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">var</span><span style="color:#E1E4E8;"> o </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">  a: </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">  b: </span><span style="color:#79B8FF;">null</span></span>
<span class="line"><span style="color:#E1E4E8;">} </span><span style="color:#6A737D;">// 给对象及其包含的值分配内存</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 给数组及其包含的值分配内存（就像对象一样）</span></span>
<span class="line"><span style="color:#F97583;">var</span><span style="color:#E1E4E8;"> a </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> [</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;abra&#39;</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">function</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">f</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">a</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> a </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">2</span></span>
<span class="line"><span style="color:#E1E4E8;">} </span><span style="color:#6A737D;">// 给函数（可调用的对象）分配内存</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 函数表达式也能分配一个对象</span></span>
<span class="line"><span style="color:#E1E4E8;">someElement.</span><span style="color:#B392F0;">addEventListener</span><span style="color:#E1E4E8;">(</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">&#39;click&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">function</span><span style="color:#E1E4E8;"> () {</span></span>
<span class="line"><span style="color:#E1E4E8;">    someElement.style.backgroundColor </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;blue&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">  },</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">false</span></span>
<span class="line"><span style="color:#E1E4E8;">)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">var</span><span style="color:#24292E;"> n </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">123</span><span style="color:#24292E;"> </span><span style="color:#6A737D;">// 给数值变量分配内存</span></span>
<span class="line"><span style="color:#D73A49;">var</span><span style="color:#24292E;"> s </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;azerty&#39;</span><span style="color:#24292E;"> </span><span style="color:#6A737D;">// 给字符串分配内存</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">var</span><span style="color:#24292E;"> o </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">  a: </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">  b: </span><span style="color:#005CC5;">null</span></span>
<span class="line"><span style="color:#24292E;">} </span><span style="color:#6A737D;">// 给对象及其包含的值分配内存</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 给数组及其包含的值分配内存（就像对象一样）</span></span>
<span class="line"><span style="color:#D73A49;">var</span><span style="color:#24292E;"> a </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> [</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;abra&#39;</span><span style="color:#24292E;">]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">function</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">f</span><span style="color:#24292E;">(</span><span style="color:#E36209;">a</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> a </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2</span></span>
<span class="line"><span style="color:#24292E;">} </span><span style="color:#6A737D;">// 给函数（可调用的对象）分配内存</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 函数表达式也能分配一个对象</span></span>
<span class="line"><span style="color:#24292E;">someElement.</span><span style="color:#6F42C1;">addEventListener</span><span style="color:#24292E;">(</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#032F62;">&#39;click&#39;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">function</span><span style="color:#24292E;"> () {</span></span>
<span class="line"><span style="color:#24292E;">    someElement.style.backgroundColor </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;blue&#39;</span></span>
<span class="line"><span style="color:#24292E;">  },</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#005CC5;">false</span></span>
<span class="line"><span style="color:#24292E;">)</span></span></code></pre></div><p>当系统发现这些变量不再被使用的时候，会自动释放（垃圾回收）这些变量的内存，开发者不用过多的关心内存问题。</p><p>虽然这样，我们开发过程中也需要了解 JavaScript 的内存管理机制，这样才能避免一些不必要的问题，比如下面代码：</p><div class="language-js vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">{}</span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;">{} </span><span style="color:#6A737D;">// false</span></span>
<span class="line"><span style="color:#E1E4E8;">[]</span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;">[] </span><span style="color:#6A737D;">// false</span></span>
<span class="line"><span style="color:#9ECBFF;">&#39;&#39;</span><span style="color:#F97583;">==</span><span style="color:#9ECBFF;">&#39;&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;">// true</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">{}</span><span style="color:#D73A49;">==</span><span style="color:#24292E;">{} </span><span style="color:#6A737D;">// false</span></span>
<span class="line"><span style="color:#24292E;">[]</span><span style="color:#D73A49;">==</span><span style="color:#24292E;">[] </span><span style="color:#6A737D;">// false</span></span>
<span class="line"><span style="color:#032F62;">&#39;&#39;</span><span style="color:#D73A49;">==</span><span style="color:#032F62;">&#39;&#39;</span><span style="color:#24292E;"> </span><span style="color:#6A737D;">// true</span></span></code></pre></div><p>在 JavaScript 中，数据类型分为两类，简单类型和引用类型，对于简单类型，内存是保存在栈（stack）空间中，复杂数据类型，内存是保存在堆（heap）空间中。</p><ul><li>基本类型：这些类型在内存中分别占有固定大小的空间，他们的值保存在栈空间，我们通过按值来访问的</li><li>引用类型：引用类型，值大小不固定，栈内存中存放地址指向堆内存中的对象。是按引用访问的。</li></ul><p>而对于栈的内存空间，只保存简单数据类型的内存，由操作系统自动分配和自动释放。而堆空间中的内存，由于大小不固定，系统无法无法进行自动释放，这个时候就需要 JS 引擎来手动的释放这些内存。</p><h3 id="为什么需要垃圾回收" tabindex="-1">为什么需要垃圾回收 <a class="header-anchor" href="#为什么需要垃圾回收" aria-label="Permalink to &quot;为什么需要垃圾回收&quot;">​</a></h3><p>在 Chrome 中，v8 被限制了内存的使用（64 位约 1.4G/1464MB ， 32 位约 0.7G/732MB），为什么要限制呢？</p><ol><li>表层原因是，V8 最初为浏览器而设计，不太可能遇到用大量内存的场景</li><li>深层原因是，V8 的垃圾回收机制的限制（如果清理大量的内存垃圾是很耗时间，这样会引起 JavaScript 线程暂停执行的时间，那么性能和应用直线下降）</li></ol><p>前面说到栈内的内存，操作系统会自动进行内存分配和内存释放，而堆中的内存，由 JS 引擎（如 Chrome 的 V8）手动进行释放，当我们的代码没有按照正确的写法时，会使得 JS 引擎的垃圾回收机制无法正确的对内存进行释放（内存泄露），从而使得浏览器占用的内存不断增加，进而导致 JavaScript 和应用、操作系统性能下降。</p><h3 id="chrome-垃圾回收算法" tabindex="-1">Chrome 垃圾回收算法 <a class="header-anchor" href="#chrome-垃圾回收算法" aria-label="Permalink to &quot;Chrome 垃圾回收算法&quot;">​</a></h3><p>在 JavaScript 中，其实绝大多数的对象存活周期都很短，大部分在经过一次的垃圾回收之后，内存就会被释放掉，而少部分的对象存活周期将会很长，一直是活跃的对象，不需要被回收。为了提高回收效率，V8 将堆分为两类<code>新生代</code>和<code>老生代</code>，新生代中存放的是生存时间短的对象，老生代中存放的生存时间久的对象。</p><p>新生区通常只支持 1 ～ 8M 的容量，而老生区支持的容量就大很多了。对于这两块区域，V8 分别使用两个不同的垃圾回收器，以便更高效地实施垃圾回收。</p><ul><li>副垃圾回收器 - Scavenge：主要负责新生代的垃圾回收。</li><li>主垃圾回收器 - Mark-Sweep &amp; Mark-Compact：主要负责老生代的垃圾回收。</li></ul><h4 id="新生代垃圾回收器-scavenge" tabindex="-1">新生代垃圾回收器 - Scavenge <a class="header-anchor" href="#新生代垃圾回收器-scavenge" aria-label="Permalink to &quot;新生代垃圾回收器 - Scavenge&quot;">​</a></h4><p>在 JavaScript 中，任何对象的声明分配到的内存，将会先被放置在新生代中，而因为大部分对象在内存中存活的周期很短，所以需要一个效率非常高的算法。在新生代中，主要使用<code>Scavenge</code>算法进行垃圾回收，<code>Scavenge</code>算法是一个典型的牺牲空间换取时间的复制算法，在占用空间不大的场景上非常适用。</p><p>Scavange 算法将新生代堆分为两部分，分别叫<code>from-space</code>和<code>to-space</code>，工作方式也很简单，就是将<code>from-space</code>中存活的活动对象复制到<code>to-space</code>中，并将这些对象的内存有序的排列起来，然后将<code>from-space</code>中的非活动对象的内存进行释放，完成之后，将<code>from space</code> 和<code>to space</code>进行互换，这样可以使得新生代中的这两块区域可以重复利用。</p><p><img src="/devops-doc/assets/Scavenge.ff3c98d0.png" alt="img"></p><p>简单的描述就是：</p><ul><li>标记活动对象和非活动对象</li><li>复制 from space 的活动对象到 to space 并对其进行排序</li><li>释放 from space 中的非活动对象的内存</li><li>将 from space 和 to space 角色互换</li></ul><p>那么，垃圾回收器是怎么知道哪些对象是活动对象和非活动对象的呢？</p><p>有一个概念叫对象的可达性，表示从初始的根对象（window，global）的指针开始，这个根指针对象被称为根集（root set），从这个根集向下搜索其子节点，被搜索到的子节点说明该节点的引用对象可达，并为其留下标记，然后递归这个搜索的过程，直到所有子节点都被遍历结束，那么没有被标记的对象节点，说明该对象没有被任何地方引用，可以证明这是一个需要被释放内存的对象，可以被垃圾回收器回收。</p><p>新生代中的对象什么时候变成老生代的对象呢？</p><p>在新生代中，还进一步进行了细分，分为<code>nursery</code>子代和<code>intermediate</code>子代两个区域，一个对象第一次分配内存时会被分配到新生代中的<code>nursery</code>子代，如果进过下一次垃圾回收这个对象还存在新生代中，这时候我们移动到 <code>intermediate</code> 子代，再经过下一次垃圾回收，如果这个对象还在新生代中，副垃圾回收器会将该对象移动到老生代中，这个移动的过程被称为晋升。</p><h4 id="老生代垃圾回收-mark-sweep-mark-compact" tabindex="-1">老生代垃圾回收 - Mark-Sweep &amp; Mark-Compact <a class="header-anchor" href="#老生代垃圾回收-mark-sweep-mark-compact" aria-label="Permalink to &quot;老生代垃圾回收 - Mark-Sweep &amp; Mark-Compact&quot;">​</a></h4><p>新生代空间中的对象满足一定条件后，晋升到老生代空间中，在老生代空间中的对象都已经至少经历过一次或者多次的回收所以它们的存活概率会更大，如果这个时候再使用<code>scavenge</code>算法的话，会出现两个问题：</p><ul><li>scavenge 为复制算法，重复复制活动对象会使得效率低下</li><li>scavenge 是牺牲空间来换取时间效率的算法，而老生代支持的容量较大，会出现空间资源浪费问题</li></ul><p>所以在老生代空间中采用了 Mark-Sweep（标记清除） 和 Mark-Compact（标记整理） 算法。</p><h5 id="mark-sweep" tabindex="-1">Mark-Sweep <a class="header-anchor" href="#mark-sweep" aria-label="Permalink to &quot;Mark-Sweep&quot;">​</a></h5><p>Mark-Sweep 处理时分为两阶段，标记阶段和清理阶段，看起来与 Scavenge 类似，不同的是，Scavenge 算法是复制活动对象，而由于在老生代中活动对象占大多数，所以 Mark-Sweep 在标记了活动对象和非活动对象之后，直接把非活动对象清除。</p><ul><li>标记阶段：对老生代进行第一次扫描，标记活动对象</li><li>清理阶段：对老生代进行第二次扫描，清除未被标记的对象，即清理非活动对象</li></ul><p><img src="/devops-doc/assets/Mark-Sweep.2a0c1b38.png" alt="img"></p><p>看似一切 perfect，但是还遗留一个问题，被清除的对象遍布于各内存地址，产生很多内存碎片。</p><h5 id="mark-compact" tabindex="-1">Mark-Compact <a class="header-anchor" href="#mark-compact" aria-label="Permalink to &quot;Mark-Compact&quot;">​</a></h5><p>由于 Mark-Sweep 完成之后，老生代的内存中产生了很多内存碎片，若不清理这些内存碎片，如果出现需要分配一个大对象的时候，这时所有的碎片空间都完全无法完成分配，就会提前触发垃圾回收，而这次回收其实不是必要的。</p><p>为了解决内存碎片问题，Mark-Compact 被提出，它是在 Mark-Sweep 的基础上演进而来的，相比 Mark-Sweep，Mark-Compact 添加了活动对象整理阶段，将所有的活动对象往一端移动，移动完成后，直接清理掉边界外的内存。</p><p><img src="/devops-doc/assets/Mark-Compact.48576ad1.png" alt="img"></p><h4 id="全停顿-stop-the-world" tabindex="-1">全停顿 - Stop-The-World <a class="header-anchor" href="#全停顿-stop-the-world" aria-label="Permalink to &quot;全停顿 - Stop-The-World&quot;">​</a></h4><p>由于垃圾回收是在 JS 引擎中进行的，而 Mark-Compact 算法在执行过程中需要移动对象，而当活动对象较多的时候，它的执行速度不可能很快，为了避免 JavaScript 应用逻辑和垃圾回收器的内存资源竞争导致的不一致性问题，垃圾回收器会将 JavaScript 应用暂停，这个过程，被称为<code>全停顿</code>（stop-the-world）。</p><p>在新生代中，由于空间小、存活对象较少、Scavenge 算法执行效率较快，所以全停顿的影响并不大。而老生代中就不一样，如果老生代中的活动对象较多，垃圾回收器就会暂停主线程较长的时间，使得页面变得卡顿。</p><h3 id="优化-orinoco" tabindex="-1">优化 - Orinoco <a class="header-anchor" href="#优化-orinoco" aria-label="Permalink to &quot;优化 - Orinoco&quot;">​</a></h3><p>orinoco 为 V8 的垃圾回收器的项目代号，为了提升用户体验，解决全停顿问题，它利用了增量标记、懒性清理、并发、并行来降低主线程挂起的时间。</p><h4 id="增量标记-incremental-marking" tabindex="-1">增量标记 - Incremental-marking <a class="header-anchor" href="#增量标记-incremental-marking" aria-label="Permalink to &quot;增量标记 - Incremental-marking&quot;">​</a></h4><p>为了降低全堆垃圾回收的停顿时间，增量标记将原本的标记全堆对象拆分为一个一个任务，让其穿插在 JavaScript 应用逻辑之间执行，它允许堆的标记时的 5~10ms 的停顿。增量标记在堆的大小达到一定的阈值时启用，启用之后每当一定量的内存分配后，脚本的执行就会停顿并进行一次增量标记。</p><p><img src="/devops-doc/assets/Incremental-marking.583ac973.png" alt="img"></p><h4 id="懒性清理-lazy-sweeping" tabindex="-1">懒性清理 - Lazy sweeping <a class="header-anchor" href="#懒性清理-lazy-sweeping" aria-label="Permalink to &quot;懒性清理 - Lazy sweeping&quot;">​</a></h4><p>增量标记只是对活动对象和非活动对象进行标记，惰性清理用来真正的清理释放内存。当增量标记完成后，假如当前的可用内存足以让我们快速的执行代码，其实我们是没必要立即清理内存的，可以将清理的过程延迟一下，让 JavaScript 逻辑代码先执行，也无需一次性清理完所有非活动对象内存，垃圾回收器会按需逐一进行清理，直到所有的页都清理完毕。</p><p>增量标记与惰性清理的出现，使得主线程的最大停顿时间减少了 80%，让用户与浏览器交互过程变得流畅了许多，从实现机制上，由于每个小的增量标价之间执行了 JavaScript 代码，堆中的对象指针可能发生了变化，需要使用<code>写屏障</code>技术来记录这些引用关系的变化，所以也暴露出来增量标记的缺点：</p><ul><li>并没有减少主线程的总暂停的时间，甚至会略微增加</li><li>由于写屏障（Write-barrier）机制的成本，增量标记可能会降低应用程序的吞吐量</li></ul><h4 id="并发-concurrent" tabindex="-1">并发 - Concurrent <a class="header-anchor" href="#并发-concurrent" aria-label="Permalink to &quot;并发 - Concurrent&quot;">​</a></h4><p>并发式 GC 允许在在垃圾回收的同时不需要将主线程挂起，两者可以同时进行，只有在个别时候需要短暂停下来让垃圾回收器做一些特殊的操作。但是这种方式也要面对增量回收的问题，就是在垃圾回收过程中，由于 JavaScript 代码在执行，堆中的对象的引用关系随时可能会变化，所以也要进行<code>写屏障</code>操作。</p><p><img src="/devops-doc/assets/Concurrent.ad69dc2f.png" alt="img"></p><h4 id="并行-parallel" tabindex="-1">并行 - Parallel <a class="header-anchor" href="#并行-parallel" aria-label="Permalink to &quot;并行 - Parallel&quot;">​</a></h4><p>并行式 GC 允许主线程和辅助线程同时执行同样的 GC 工作，这样可以让辅助线程来分担主线程的 GC 工作，使得垃圾回收所耗费的时间等于总时间除以参与的线程数量（加上一些同步开销）。</p><p><img src="/devops-doc/assets/Parallel.bb12e7ab.png" alt="img"></p><h3 id="v8-当前垃圾回收机制" tabindex="-1">V8 当前垃圾回收机制 <a class="header-anchor" href="#v8-当前垃圾回收机制" aria-label="Permalink to &quot;V8 当前垃圾回收机制&quot;">​</a></h3><p>2011 年，V8 应用了增量标记机制。直至 2018 年，Chrome64 和 Node.js V10 启动并发标记（Concurrent），同时在并发的基础上添加并行（Parallel）技术，使得垃圾回收时间大幅度缩短。</p><h4 id="副垃圾回收器" tabindex="-1">副垃圾回收器 <a class="header-anchor" href="#副垃圾回收器" aria-label="Permalink to &quot;副垃圾回收器&quot;">​</a></h4><p>V8 在新生代垃圾回收中，使用并行（parallel）机制，在整理排序阶段，也就是将活动对象从<code>from-to</code>复制到<code>space-to</code>的时候，启用多个辅助线程，并行的进行整理。由于多个线程竞争一个新生代的堆的内存资源，可能出现有某个活动对象被多个线程进行复制操作的问题，为了解决这个问题，V8 在第一个线程对活动对象进行复制并且复制完成后，都必须去维护复制这个活动对象后的指针转发地址，以便于其他协助线程可以找到该活动对象后可以判断该活动对象是否已被复制。</p><p><img src="/devops-doc/assets/副垃圾回收器.b226f72e.png" alt="img"></p><h4 id="主垃圾回收器" tabindex="-1">主垃圾回收器 <a class="header-anchor" href="#主垃圾回收器" aria-label="Permalink to &quot;主垃圾回收器&quot;">​</a></h4><p>V8 在老生代垃圾回收中，如果堆中的内存大小超过某个阈值之后，会启用并发（Concurrent）标记任务。每个辅助线程都会去追踪每个标记到的对象的指针以及对这个对象的引用，而在 JavaScript 代码执行时候，并发标记也在后台的辅助进程中进行，当堆中的某个对象指针被 JavaScript 代码修改的时候，写入屏障（<a href="https://link.zhihu.com/?target=https%3A//dl.acm.org/citation.cfm%3Fid%3D2025255" target="_blank" rel="noreferrer">write barriers</a>）技术会在辅助线程在进行并发标记的时候进行追踪。</p><p>当并发标记完成或者动态分配的内存到达极限的时候，主线程会执行最终的快速标记步骤，这个时候主线程会挂起，主线程会再一次的扫描根集以确保所有的对象都完成了标记，由于辅助线程已经标记过活动对象，主线程的本次扫描只是进行 check 操作，确认完成之后，某些辅助线程会进行清理内存操作，某些辅助进程会进行内存整理操作，由于都是并发的，并不会影响主线程 JavaScript 代码的执行。</p><p><img src="/devops-doc/assets/主垃圾回收器.880f3fcb.png" alt="img"></p></div></div></main><footer class="VPDocFooter" data-v-0663733c data-v-826fac5d><!--[--><!--]--><div class="edit-info" data-v-826fac5d><!----><div class="last-updated" data-v-826fac5d><p class="VPLastUpdated" data-v-826fac5d data-v-6d8d8552>Last updated: <time datetime="2024-02-17T05:48:38.000Z" data-v-6d8d8552></time></p></div></div><nav class="prev-next" data-v-826fac5d><div class="pager" data-v-826fac5d><a class="pager-link prev" href="/devops-doc/FE_Theory/V8/" data-v-826fac5d><span class="desc" data-v-826fac5d>Pagina prior</span><span class="title" data-v-826fac5d>简介</span></a></div><div class="pager" data-v-826fac5d><!----></div></nav></footer><!--[--><!--]--></div></div></div><!--[--><!--]--></div></div><!----><!--[--><!--]--></div></div>
    <script>window.__VP_HASH_MAP__=JSON.parse("{\"computer_system_windows_system_apply.md\":\"1dbf8d58\",\"computer_system_windows_index.md\":\"8d89b972\",\"computer_system_windows_software_apply.md\":\"5e743f6c\",\"computer_apply_设计模式_index.md\":\"637439db\",\"fe_point_css_plan_奇技淫巧.md\":\"cad77861\",\"computer_theory_数据结构_index.md\":\"2d5cf4e3\",\"computer_theory_计算机网络_point_连接与轮询.md\":\"f26bdccf\",\"computer_system_linux_index.md\":\"767a3785\",\"computer_apply_算法_index.md\":\"a28e5d72\",\"computer_apply_算法_search.md\":\"51c688b8\",\"computer_theory_计算机网络_optimization_重绘与重排.md\":\"af827890\",\"computer_theory_操作系统_index.md\":\"6412e90b\",\"computer_system_windows_software_setting.md\":\"e4b914dc\",\"fe_point_html_index.md\":\"99e5338d\",\"tools_git_index.md\":\"434d6ab7\",\"computer_theory_计算机组成原理_index.md\":\"0ca8fa8f\",\"computer_apply_db_index.md\":\"cd75cb8a\",\"fe_point_css_css选择器.md\":\"56196624\",\"fe_theory_v8_index.md\":\"33d1e65b\",\"computer_system_windows_system_setting.md\":\"8f2a0d65\",\"computer_system_windows_mapkeys_global.md\":\"c7fe8337\",\"tools_ops_npm_index.md\":\"905450a7\",\"fe_point_css_index.md\":\"7157a806\",\"index.md\":\"41348d2f\",\"computer_theory_计算机网络_index.md\":\"e1a24fc9\",\"tools_git_command_init.md\":\"efd7634e\",\"fe_point_css_plan_布局.md\":\"228b7440\",\"fe_point_javascript_index.md\":\"3ad9a9dc\",\"computer_theory_计算机网络_point_输入url到浏览器呈现.md\":\"b853d9a1\",\"tools_ide_jetbrains_apply_datagrip.md\":\"3d7cc652\",\"tools_ide_jetbrains_apply_webstorm.md\":\"b50fd3e4\",\"computer_system_windows_mapkeys_software.md\":\"a84ecc7b\",\"fe_point_css_css属性.md\":\"da62d8a7\",\"fe_point_css_css布局.md\":\"2dea0611\",\"tools_ide_jetbrains_index.md\":\"a73fc096\",\"tools_git_command_config.md\":\"7f7d4a25\",\"fe_theory_v8_执行环境.md\":\"ba24f863\",\"tools_git_command_branch.md\":\"0a6f2daa\",\"tools_git_command_basis.md\":\"c45a7b90\",\"computer_apply_算法_sort.md\":\"7457b7b8\"}");window.__VP_SITE_DATA__=JSON.parse("{\"lang\":\"zh-CN\",\"dir\":\"ltr\",\"title\":\"DevOps\",\"titleTemplate\":true,\"description\":\"A VitePress site\",\"base\":\"/devops-doc/\",\"head\":[],\"appearance\":\"dark\",\"themeConfig\":{\"i18nRouting\":false,\"siteTitle\":\"DevOps\",\"nav\":[{\"text\":\"计算机\",\"items\":[{\"text\":\"计算机基础\",\"items\":[{\"text\":\"操作系统\",\"link\":\"/Computer_Theory/操作系统/\"},{\"text\":\"计算机组成原理\",\"link\":\"/Computer_Theory/计算机组成原理/\"},{\"text\":\"计算机网络\",\"link\":\"/Computer_Theory/计算机网络/\"},{\"text\":\"数据结构\",\"link\":\"/Computer_Theory/数据结构/\"}]},{\"text\":\"计算机应用\",\"items\":[{\"text\":\"数据库\",\"link\":\"/Computer_Apply/DB/\"},{\"text\":\"设计模式\",\"link\":\"/Computer_Apply/设计模式/\"},{\"text\":\"算法\",\"link\":\"/Computer_Apply/算法/\"}]},{\"text\":\"计算机系统\",\"items\":[{\"text\":\"Windows\",\"link\":\"/Computer_System/Windows/\"},{\"text\":\"Linux\",\"link\":\"/Computer_System/Linux/\"}]}]},{\"text\":\"前端\",\"items\":[{\"text\":\"原理\",\"items\":[{\"text\":\"V8\",\"link\":\"/FE_Theory/V8/\"}]},{\"text\":\"要点\",\"items\":[{\"text\":\"HTML\",\"link\":\"/FE_Point/HTML/\"},{\"text\":\"CSS\",\"link\":\"/FE_Point/CSS/\"},{\"text\":\"JavaScript\",\"link\":\"/FE_Point/JavaScript/\"}]}]},{\"text\":\"工具\",\"items\":[{\"text\":\"IDE\",\"items\":[{\"text\":\"JetBrains\",\"link\":\"/Tools_IDE/JetBrains/\"}]},{\"text\":\"Ops\",\"items\":[{\"text\":\"Git\",\"link\":\"/Tools_Git/\"},{\"text\":\"Npm\",\"link\":\"/Tools_Ops/Npm/\"}]}]}],\"sidebar\":{\"/Computer_Theory/计算机网络\":[{\"text\":\"计算机网络\",\"items\":[]},{\"text\":\"指南：\",\"items\":[{\"text\":\"简介\",\"link\":\"/Computer_Theory/计算机网络/\"}]},{\"text\":\"要点：\",\"items\":[{\"text\":\"输入URL到浏览器呈现\",\"link\":\"/Computer_Theory/计算机网络/Point/输入URL到浏览器呈现\"},{\"text\":\"连接与轮询\",\"link\":\"/Computer_Theory/计算机网络/Point/连接与轮询\"}]},{\"text\":\"优化：\",\"items\":[{\"text\":\"重绘与重排\",\"link\":\"/Computer_Theory/计算机网络/Optimization/重绘与重排\"}]}],\"/Computer_Apply/DB\":[{\"text\":\"数据库\",\"items\":[]},{\"text\":\"指南：\",\"items\":[{\"text\":\"简介\",\"link\":\"/Computer_Apply/DB/\"}]}],\"/Computer_Apply/算法\":[{\"text\":\"算法\",\"items\":[]},{\"text\":\"指南：\",\"items\":[{\"text\":\"简介\",\"link\":\"/Computer_Apply/算法/\"}]},{\"text\":\"算法：\",\"items\":[{\"text\":\"查找\",\"link\":\"/Computer_Apply/算法/Search\"},{\"text\":\"排序\",\"link\":\"/Computer_Apply/算法/Sort\"}]}],\"/Computer_System/Windows\":[{\"text\":\"Windows\",\"items\":[]},{\"text\":\"指南：\",\"items\":[{\"text\":\"简介\",\"link\":\"/Computer_System/Windows/\"}]},{\"text\":\"系统：\",\"items\":[{\"text\":\"配置\",\"link\":\"/Computer_System/Windows/System/Setting\"},{\"text\":\"使用\",\"link\":\"/Computer_System/Windows/System/Apply\"}]},{\"text\":\"软件：\",\"items\":[{\"text\":\"配置\",\"link\":\"/Computer_System/Windows/Software/Setting\"},{\"text\":\"使用\",\"link\":\"/Computer_System/Windows/Software/Apply\"}]},{\"text\":\"快捷键：\",\"items\":[{\"text\":\"全局\",\"link\":\"/Computer_System/Windows/MapKeys/Global\"},{\"text\":\"软件\",\"link\":\"/Computer_System/Windows/MapKeys/Software\"}]}],\"/Computer_System/Linux\":[{\"text\":\"Linux\",\"items\":[]},{\"text\":\"指南：\",\"items\":[{\"text\":\"简介\",\"link\":\"/Computer_System/Linux/\"}]}],\"/Tools_Git\":[{\"text\":\"Git\",\"items\":[]},{\"text\":\"指南：\",\"items\":[{\"text\":\"简介\",\"link\":\"/Tools_Git/\"}]},{\"text\":\"命令：\",\"items\":[{\"text\":\"配置\",\"link\":\"/Tools_Git/Command/config\"},{\"text\":\"初始化\",\"link\":\"/Tools_Git/Command/init\"},{\"text\":\"基础\",\"link\":\"/Tools_Git/Command/basis\"},{\"text\":\"分支\",\"link\":\"/Tools_Git/Command/branch\"}]}],\"/Tools_Ops/Npm\":[{\"text\":\"Npm\",\"items\":[]},{\"text\":\"指南：\",\"items\":[{\"text\":\"简介\",\"link\":\"/Tools_Ops/Npm/\"}]}],\"/Tools_IDE/JetBrains\":[{\"text\":\"JetBrains\",\"items\":[]},{\"text\":\"指南：\",\"items\":[{\"text\":\"简介\",\"link\":\"/Tools_IDE/JetBrains/\"}]},{\"text\":\"使用：\",\"items\":[{\"text\":\"WebStorm\",\"link\":\"/Tools_IDE/JetBrains/Apply/WebStorm\"},{\"text\":\"DataGrip\",\"link\":\"/Tools_IDE/JetBrains/Apply/DataGrip\"}]}],\"/FE_Theory/V8\":[{\"text\":\"V8\",\"items\":[]},{\"text\":\"指南：\",\"items\":[{\"text\":\"简介\",\"link\":\"/FE_Theory/V8/\"},{\"text\":\"执行环境\",\"link\":\"/FE_Theory/V8/执行环境\"}]}],\"/FE_Point/HTML\":[{\"text\":\"HTML\",\"items\":[]},{\"text\":\"指南：\",\"items\":[{\"text\":\"简介\",\"link\":\"/FE_Point/HTML/\"}]}],\"/FE_Point/CSS\":[{\"text\":\"CSS\",\"items\":[]},{\"text\":\"指南：\",\"items\":[{\"text\":\"简介\",\"link\":\"/FE_Point/CSS/\"}]},{\"text\":\"要点：\",\"items\":[{\"text\":\"CSS选择器\",\"link\":\"/FE_Point/CSS/CSS选择器\"},{\"text\":\"CSS属性\",\"link\":\"/FE_Point/CSS/CSS属性\"},{\"text\":\"CSS布局\",\"link\":\"/FE_Point/CSS/CSS布局\"}]},{\"text\":\"方案：\",\"items\":[{\"text\":\"布局\",\"link\":\"/FE_Point/CSS/Plan/布局\"},{\"text\":\"奇技淫巧\",\"link\":\"/FE_Point/CSS/Plan/奇技淫巧\"}]}],\"/FE_Point/JavaScript\":[{\"text\":\"JavaScript\",\"items\":[]},{\"text\":\"指南：\",\"items\":[{\"text\":\"简介\",\"link\":\"/FE_Point/JavaScript/\"}]}]},\"aside\":true,\"outline\":{\"level\":[2,3],\"label\":\"本页目录\"},\"socialLinks\":[{\"icon\":\"github\",\"link\":\"https://github.com/True-Z\"}],\"lastUpdated\":{\"text\":\"Last updated\"},\"search\":{\"provider\":\"local\"},\"docFooter\":{\"prev\":\"Pagina prior\",\"next\":\"Proxima pagina\"},\"darkModeSwitchLabel\":\"Appearance\",\"sidebarMenuLabel\":\"Menu\",\"returnToTopLabel\":\"Return to top\",\"langMenuLabel\":\"Change language\",\"externalLinkIcon\":false},\"locales\":{},\"scrollOffset\":90,\"cleanUrls\":false}");</script>
    
  </body>
</html>